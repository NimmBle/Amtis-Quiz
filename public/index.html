<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/styles.css" />
    <title>Quiz</title>
  </head>
  <body>
    <h2>Real-time Quiz</h2>

    <div id="setup" class="row">
      <input id="name" class="input" placeholder="Enter your name" />
      <input id="extId" class="input" placeholder="Enter your ID" />
      <button id="joinBtn" class="btn btn--primary">Join</button>
    </div>

    <div id="teamSection" style="display:none;">
      <h3 id="welcomeHeader">Welcome <span id="playerName"></span>
        <button id="leaveBtn" class="btn" style="display:none;">Leave Team</button>
      </h3>
      <div id="createTeamControls" class="row">
        <input id="teamName" class="input" placeholder="Create team name" />
        <button id="createTeamBtn" class="btn">Create Team</button>
      </div>

      <div id="existingTeams">
        <h4>Or join existing:</h4>
        <ul id="teamsList"></ul>
      </div>

      <div id="currentTeamSection" class="mt-3" style="display:none;">
        <h4>Your Team: <span id="currentTeamName"></span></h4>
        <ul id="memberList"></ul>
      </div>

      <div id="gameSection" class="mt-4" style="display:none;">
        <h3>Question</h3>
        <div id="questionView">
          <img id="qImageEl" alt="question" style="max-width: 260px; display:none;" />
          <p id="qTextEl"></p>
          <p id="qHintEl" style="display:none; color:#555;"></p>
        </div>
        <div class="row">
          <input id="answerInput" class="input" placeholder="Your answer" />
          <button id="submitAnswerBtn" class="btn btn--primary">Submit</button>
        </div>
        <div id="hintControls" class="row" style="margin-top:8px;">
          <span>Hints left: <strong id="hintsLeft">0</strong></span>
          <button id="getHintBtn" class="btn">Get Hint</button>
        </div>
        <div id="finishedNotice" style="display:none; margin-top:8px; color:#0a0;">
          Good job! You have completed all questions. Waiting for other teams to finish.
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const playerNameSpan = document.getElementById("playerName");
      const leaveBtn = document.getElementById("leaveBtn");
      const createTeamControls = document.getElementById("createTeamControls");
      const existingTeams = document.getElementById("existingTeams");
      const currentTeamSection = document.getElementById("currentTeamSection");
      const currentTeamNameSpan = document.getElementById("currentTeamName");
      const memberList = document.getElementById("memberList");
      const gameSection = document.getElementById("gameSection");
      const qImageEl = document.getElementById("qImageEl");
      const qTextEl = document.getElementById("qTextEl");
      const qHintEl = document.getElementById("qHintEl");
      const answerInput = document.getElementById("answerInput");
      const submitAnswerBtn = document.getElementById("submitAnswerBtn");
      const hintControls = document.getElementById('hintControls');
      const hintsLeftEl = document.getElementById('hintsLeft');
      const getHintBtn = document.getElementById('getHintBtn');
      const welcomeHeader = document.getElementById("welcomeHeader");
      const finishedNotice = document.getElementById("finishedNotice");
      let isCreator = false;
      // (removed) frozen notice banner per request
      leaveBtn.onclick = () => socket.emit("leave_team");

      document.getElementById("joinBtn").onclick = () => {
        const name = document.getElementById("name").value.trim();
        const extId = document.getElementById("extId").value.trim();
        if (!name || !extId) {
          alert("Please enter both your name and ID.");
          return;
        }
        try { localStorage.setItem("externalId", extId); } catch {}
        socket.emit("join_player", { name, external_id: extId });
      };

      document.getElementById("createTeamBtn").onclick = () => {
        const teamName = document.getElementById("teamName").value.trim();
        if (!teamName) { alert("Please enter a team name"); return; }
        // Client-side check for existing team name for instant feedback
        try {
          if ((lastTeams || []).some(t => (t.name || '').toLowerCase() === teamName.toLowerCase())) {
            alert("Team name taken!");
            return;
          }
        } catch {}
        socket.emit("create_team", teamName);
      };

      document.getElementById("teamsList").onclick = () => {
        
      }
      socket.on("joined_as_player", (name) => {
        document.getElementById("setup").style.display = "none";
        document.getElementById("teamSection").style.display = "block";
        playerNameSpan.textContent = name;
        try { localStorage.setItem("playerName", name); } catch {}
        socket.emit('player_get_info');
      });

      socket.on("name_taken", () => alert("Name already taken!"));
      socket.on("resume_failed", () => {
        try { localStorage.removeItem("playerName"); } catch {}
      });
      socket.on("name_taken", () => alert("Team name taken!"));
      socket.on("team_full", () => alert("Team full!"));

      let lastTeams = [];
      let lastQuestions = [];
      let lastGame = null;
      let lastHints = { used: 0, left: 0, max: 0, hintedQuestionIds: [] };

      function renderQuestion() {
        if (!lastGame || !lastGame.started) {
          gameSection.style.display = 'none';
          finishedNotice.style.display = 'none';
          return;
        }
        const playerName = playerNameSpan.textContent;
        const currentTeam = lastTeams.find(t => t.players.includes(playerName));
        if (!currentTeam) { gameSection.style.display = 'none'; finishedNotice.style.display = 'none'; return; }
        const pos = currentTeam.current_question;
        const q = lastQuestions.find(qq => qq.position === pos);
        if (!q) {
          // no more questions for this team
          gameSection.style.display = 'none';
          finishedNotice.style.display = 'block';
          return;
        }
        qImageEl.style.display = q.image_url ? 'block' : 'none';
        if (q.image_url) qImageEl.src = q.image_url;
        qTextEl.textContent = q.text || '';
        gameSection.style.display = 'block';
        finishedNotice.style.display = 'none';
        // show hint if already taken for this question
        if (lastHints.hintedQuestionIds && lastHints.hintedQuestionIds.includes(q.id)) {
          qHintEl.style.display = 'block';
          qHintEl.textContent = `Hint: ${q.hint || ''}`;
        } else {
          qHintEl.style.display = 'none';
          qHintEl.textContent = '';
        }
        // refresh hints state when showing a question
        socket.emit('player_get_hints_state');
      }
      socket.on("teams_update", (teams) => {
        const list = document.getElementById("teamsList");
        list.innerHTML = "";

        const playerName = playerNameSpan.textContent;
        const currentTeam = teams.find(t => t.players.includes(playerName));
        lastTeams = teams;
        leaveBtn.style.display = currentTeam ? "inline-block" : "none";
        // Refresh captain status on any team change
        socket.emit('player_get_info');

        // If the game is in progress, keep team UI hidden and focus on the question view
        if (lastGame && lastGame.started) {
          if (welcomeHeader) welcomeHeader.style.display = 'none';
          createTeamControls.style.display = 'none';
          existingTeams.style.display = 'none';
          currentTeamSection.style.display = 'none';
          leaveBtn.style.display = 'none';
          renderQuestion();
          return;
        }

        if (currentTeam) {
          createTeamControls.style.display = "none";
          existingTeams.style.display = "none";
          currentTeamSection.style.display = "block";
          currentTeamNameSpan.textContent = currentTeam.name;
          memberList.innerHTML = "";
          currentTeam.players.forEach((p) => {
            const li = document.createElement("li");
            li.textContent = p + (currentTeam.captain && currentTeam.captain === p ? " (captain)" : "");
            memberList.appendChild(li);
          });
          renderQuestion();
          return;
        } else {
          createTeamControls.style.display = "block";
          existingTeams.style.display = "block";
          currentTeamSection.style.display = "none";
        }

        teams.forEach((team) => {
          const li = document.createElement("li");
          const isCurrent = currentTeam && currentTeam.name === team.name;

          const label = document.createElement("span");
          label.textContent = `${team.name} (${team.players.length}/5)` + (isCurrent ? " — your team" : "");
          li.appendChild(label);

          if (isCurrent) {
            const leaveBtn = document.createElement("button");
            leaveBtn.className = 'btn';
            leaveBtn.textContent = "Leave";
            leaveBtn.onclick = () => socket.emit("leave_team");
            li.appendChild(leaveBtn);
          } else if (!currentTeam) {
            const joinBtn = document.createElement("button");
            joinBtn.className = 'btn';
            joinBtn.textContent = "Join";
            joinBtn.onclick = () => socket.emit("join_team", team.name);
            li.appendChild(joinBtn);
          }

          list.appendChild(li);
        });
      });

      socket.on("must_leave_first", () => alert("Leave your current team before joining another."));

      function setFrozenUI(isFrozen) {
        if (isFrozen) {
          createTeamControls.style.display = 'none';
          existingTeams.style.display = 'none';
          leaveBtn.style.display = 'none';
        }
      }
      socket.on("questions_payload", (payload) => {
        lastQuestions = payload.questions || [];
        lastGame = payload.game || null;
        if (lastGame && lastGame.started) {
          // hide team UI when game is active
          leaveBtn.style.display = 'none';
          createTeamControls.style.display = 'none';
          existingTeams.style.display = 'none';
          currentTeamSection.style.display = 'none';
          if (welcomeHeader) welcomeHeader.style.display = 'none';
        } else {
          if (welcomeHeader) welcomeHeader.style.display = '';
        }
        renderQuestion();
      });

      submitAnswerBtn.onclick = () => {
        const val = answerInput.value.trim();
        if (!val) return;
        socket.emit('submit_answer', val);
      };

      socket.on('answer_result', (res) => {
        if (!res || !res.correct) {
          alert(res && res.message ? res.message : 'Wrong answer. Try again.');
          return;
        }
        // correct: optionally clear input; next question renders from teams_update
        answerInput.value = '';
      });

      // Hints: request and update
      getHintBtn.onclick = () => {
        socket.emit('request_hint');
      };

      socket.on('hints_state', (stateHints) => {
        lastHints = stateHints || { used: 0, left: 0, max: 0, hintedQuestionIds: [] };
        const left = (lastHints && typeof lastHints.left === 'number') ? lastHints.left : 0;
        hintsLeftEl.textContent = String(left);
        // hide hint button for non-captains; show for captains with hints left
        hintControls.style.display = isCreator ? '' : 'none';
        getHintBtn.disabled = left <= 0 || !isCreator;
        // re-render question hint visibility in case state changed
        renderQuestion();
      });

      socket.on('hint_revealed', (payload) => {
        // Only care if it's our team
        const playerName = playerNameSpan.textContent;
        const currentTeam = lastTeams.find(t => t.players.includes(playerName));
        if (!currentTeam || !payload || payload.teamId !== currentTeam.id) return;
        // Update counters and show hint if it's for the current question
        hintsLeftEl.textContent = String(payload.left ?? hintsLeftEl.textContent);
        const posTeam = currentTeam.current_question;
        const q = lastQuestions.find(qq => qq.position === posTeam);
        if (q && payload.questionId === q.id) {
          qHintEl.style.display = 'block';
          qHintEl.textContent = `Hint: ${payload.hint || ''}`;
        }
      });

      // Show answer controls only for team captains
      socket.on('player_info', (info) => {
        isCreator = !!(info && info.is_creator);
        const controls = answerInput.parentElement;
        if (controls) controls.style.display = isCreator ? '' : 'none';
        hintControls.style.display = isCreator ? '' : 'none';
      });

      socket.on("game_started", () => {
        alert("Game started!");
        if (welcomeHeader) welcomeHeader.style.display = 'none';
        leaveBtn.style.display = 'none';
        createTeamControls.style.display = 'none';
        existingTeams.style.display = 'none';
        currentTeamSection.style.display = 'none';
        socket.emit('player_get_questions');
        socket.emit('player_get_hints_state');
      });
      socket.on("game_ended", () => {
        alert("Game ended!");
        lastGame = { started: 0, ended: 1 };
        // on end, re-show base UI; team list logic will toggle specifics
        if (welcomeHeader) welcomeHeader.style.display = '';
        finishedNotice.style.display = 'none';
        gameSection.style.display = 'none';
        createTeamControls.style.display = 'block';
        existingTeams.style.display = 'block';
        renderQuestion();
      });
      socket.on("game_frozen", () => alert("Teams are locked. You must wait until the game ends."));

      try {
        const saved = localStorage.getItem("playerName");
        const savedId = localStorage.getItem("externalId");
        if (savedId) {
          const idEl = document.getElementById("extId");
          if (idEl) idEl.value = savedId;
        }
        if (saved) {
          socket.emit("resume", saved);
          socket.emit('player_get_questions');
          socket.emit('player_get_info');
          socket.emit('player_get_hints_state');
        }
      } catch {}
    </script>
  </body>
</html>





