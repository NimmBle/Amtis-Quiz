<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Sofia+Sans:ital,wght@0,1..1000;1,1..1000&display=swap" rel="stylesheet">
    <title>Quiz</title>
  </head>
  <body>
    <header>
      <!-- <img src="./images/logo-rtppp.jpg" alt="logo-az-moga"> -->
      <span class="name">‚Äû–ê–∑ –º–æ–≥–∞ ‚Äî —Ç—É–∫ –∏ —Å–µ–≥–∞‚Äù</span>
    </header>

    <main class="app-container">
    <div id="setup" class="d-f-fd-c register">
      <img src="/images/logo-quest.svg" alt="logo-az-moga-guest">
      <span class="register-heading">–í—Ä–µ–º–µ –µ –∑–∞ <span class="accent-word">–º–∏—Å–∏—è</span>!</span>
      <span>–í–ª–µ–∑, –∑–∞ –¥–∞ –æ—Ç–∫–ª—é—á–∏—à —Å–ª–µ–¥–≤–∞—â–æ—Ç–æ –Ω–∏–≤–æ –æ—Ç –Ω–∞—à–∏—è –∫—É–µ—Å—Ç. –ü–æ–¥–≥–æ—Ç–≤–∏ —Å–µ ‚Äì –ª–æ–≥–∏–∫–∞—Ç–∞, –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–Ω–æ—Å—Ç—Ç–∞ –∏ –±—ä—Ä–∑–∞—Ç–∞ –º–∏—Å—ä–ª —â–µ –±—ä–¥–∞—Ç —Ç–≤–æ–∏—Ç–µ –æ—Ä—ä–∂–∏—è.</span>
      <input id="name" class="input" placeholder="–í—ä–≤–µ–¥–∏ –∏–º–µ—Ç–æ —Å–∏" />
      <input id="extId" class="input" placeholder="–í—ä–≤–µ–¥–∏ ID-—Ç–æ –æ—Ç –±–∞–¥–∂–∞ —Å–∏" />
      <button id="joinBtn" class="btn btn--primary">–í–∫–ª—é—á–∏ —Å–µ</button>
    </div>

    <div id="teamSection" style="display:none;">
      <div id="welcomeHeader" class="welcome-header">
        <h3>
          –•–µ–π, <span id="playerName" class="accent-word"></span>!
        </h3>
        <button id="leaveBtn" class="btn--leave" style="display:none;">–ù–∞–ø—É—Å–Ω–∏ –æ—Ç–±–æ—Ä–∞</button>
      </div>

      <div id="createTeamControls" class="row create-team-section">
        <span>–°—Ç–∞–Ω–∏ –∫–∞–ø–∏—Ç–∞–Ω –∏ —Å—ä–∑–¥–∞–π —Å–≤–æ–π –æ—Ç–±–æ—Ä</span>
        <input id="teamName" class="input" placeholder="–ò–º–µ –Ω–∞ –æ—Ç–±–æ—Ä–∞" />
        <button id="createTeamBtn" class="btn btn--primary">–°—ä–∑–¥–∞–π –æ—Ç–±–æ—Ä</button>
      </div>

      <div id="existingTeams" class="existing-teams">
        <span>–ò–ª–∏ —Å–µ –≤–∫–ª—é—á–∏ –∫—ä–º –≤–µ—á–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞—â</span>
        <ul id="teamsList" class="teams"></ul>
      </div>

      <div id="currentTeamSection" class="your-team" style="display:none;">
        <h4>–¢–≤–æ—è—Ç –æ—Ç–±–æ—Ä –µ: <span id="currentTeamName"></span></h4>
        <ul id="memberList"></ul>
      </div>
      <div id="gameSection" class="mt-4 question-section" style="display:none;">
        <h3 id="gameSectionHeading">–ó–∞–≥–∞–¥–∫–∞</h3>
        <div id="questionView">
          <img id="qImageEl" alt="question" style="display:none;" />
          <div id="qImageLoader" class="img-loader" style="display:none;" aria-label="–ó–∞—Ä–µ–∂–¥–∞–Ω–µ..."></div>
          <p id="qTextEl"></p>
          <p id="qHintEl" style="display:none; color:#555;"></p>
        </div>
        <div class="d-f-fd-c answer-holder">
          <input id="answerInput" class="input" placeholder="–í–∞—à–∏—è—Ç –æ—Ç–≥–æ–≤–æ—Ä:" />
          <button id="submitAnswerBtn" class="btn btn--primary btn--submit">–î–∞–ª–∏ –ø–æ–∑–Ω–∞—Ö?</button>
        </div>
        <div id="teamToolsContainer" class="team-tools" style="display:none;">
          <button id="teamToolsToggle" class="team-tools__toggle" type="button" aria-expanded="false">
            <i><span>–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∏ –æ–ø—Ü–∏–∏</span></i>
            <span class="team-tools__badge" id="teamToolsBadge" style="display:none;"></span>
            <span id="teamToolsChevron" aria-hidden="true">  > </span>
          </button>
          <div id="teamToolsContent" class="team-tools__content" style="display:none;">
            <div id="hintControls" class="d-f-fd-c hint-controls">
              <span>–û—Å—Ç–∞–≤–∞—â–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏: <strong id="hintsLeft">0</strong></span>
              <button id="getHintBtn" class="btn">–ù—É–∂–Ω–∞ –º–∏ –µ –ø–æ–¥—Å–∫–∞–∑–∫–∞</button>
            </div>
            <div id="teamToolsRequests" class="team-tools__requests"></div>
          </div>
        </div>
      </div>
      <div id="finishedNotice" style="display:none; margin-top:8px; color:#0a0;">
         <!-- –°—Ç—Ä–∞—Ö–æ—Ç–Ω–∞ —Ä–∞–±–æ—Ç–∞! –¢–∏ —Å–µ —Å–ø—Ä–∞–≤–∏ —Å –≤—Å–∏—á–∫–∏ –∑–∞–≥–∞–¥–∫–∏ –±–µ–∑—É–ø—Ä–µ—á–Ω–æ! -->
      </div>
    </div>

    </main>

    <div id="appLoader" class="app-loader" role="status" aria-live="polite">
      <div class="app-loader__spinner" aria-hidden="true"></div>
      <p>–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const playerNameSpan = document.getElementById("playerName");
      const leaveBtn = document.getElementById("leaveBtn");
      const createTeamControls = document.getElementById("createTeamControls");
      const existingTeams = document.getElementById("existingTeams");
      const currentTeamSection = document.getElementById("currentTeamSection");
      const currentTeamNameSpan = document.getElementById("currentTeamName");
      const memberList = document.getElementById("memberList");
      const gameSection = document.getElementById("gameSection");
      const gameSectionHeading = document.getElementById("gameSectionHeading");
      const qImageEl = document.getElementById("qImageEl");
      const qImageLoader = document.getElementById("qImageLoader");
      const qTextEl = document.getElementById("qTextEl");
      const qHintEl = document.getElementById("qHintEl");
      // const questionViewEl = document.getElementById("questionView");
      const answerInput = document.getElementById("answerInput");
      const submitAnswerBtn = document.getElementById("submitAnswerBtn");
      const hintControls = document.getElementById('hintControls');
      const hintsLeftEl = document.getElementById('hintsLeft');
      const getHintBtn = document.getElementById('getHintBtn');
      const teamToolsContainer = document.getElementById('teamToolsContainer');
      const teamToolsToggle = document.getElementById('teamToolsToggle');
      const teamToolsContent = document.getElementById('teamToolsContent');
      const teamToolsChevron = document.getElementById('teamToolsChevron');
      const teamToolsRequests = document.getElementById('teamToolsRequests');
      const teamToolsBadge = document.getElementById('teamToolsBadge');
      // Join approval UI helpers
      const existingTeamsEl = document.getElementById('existingTeams');
      const joinPending = document.createElement('div');
      joinPending.id = 'joinPending';
      joinPending.className = 'muted';
      joinPending.style.display = 'none';
      if (existingTeamsEl) existingTeamsEl.insertBefore(joinPending, existingTeamsEl.firstChild);
      let pendingJoinFor = null;
      const welcomeHeader = document.getElementById("welcomeHeader");
      const finishedNotice = document.getElementById("finishedNotice");
      let isCreator = false;
      const appLoader = document.getElementById("appLoader");
      let initialTeamsLoaded = false;
      let initialQuestionsLoaded = false;
      let resumeInFlight = false;
      let hasTeam = false;
      let teamToolsOpen = false;
      const setTeamToolsOpen = (open) => {
        teamToolsOpen = !!open;
        if (!teamToolsContent || !teamToolsToggle || !teamToolsChevron) return;
        teamToolsContent.style.display = teamToolsOpen ? 'block' : 'none';
        teamToolsToggle.setAttribute('aria-expanded', teamToolsOpen ? 'true' : 'false');
        // teamToolsChevron.textContent = teamToolsOpen ? '‚ñ≤' : '‚ñº';
      };
      if (teamToolsToggle) {
        teamToolsToggle.addEventListener('click', () => setTeamToolsOpen(!teamToolsOpen));
      }
      const showAlert = (text, icon = 'info') => {
        Swal.fire({
          text,
          icon,
          confirmButtonText: '–î–æ–±—Ä–µ',
          confirmButtonColor: '#0e1a2a'
        });
      };
      const setLoaderVisible = (isVisible) => {
        if (!appLoader) return;
        appLoader.style.display = isVisible ? 'flex' : 'none';
        document.body.classList.toggle('is-loading', isVisible);
      };
      const maybeHideLoader = () => {
        if (initialTeamsLoaded && initialQuestionsLoaded) {
          setLoaderVisible(false);
        }
      };
      const resetInitialDataState = () => {
        initialTeamsLoaded = false;
        initialQuestionsLoaded = false;
        setLoaderVisible(true);
      };
      const markTeamsReady = () => {
        if (!initialTeamsLoaded) {
          initialTeamsLoaded = true;
          maybeHideLoader();
        }
      };
      const markQuestionsReady = () => {
        if (!initialQuestionsLoaded) {
          initialQuestionsLoaded = true;
          maybeHideLoader();
        }
      };
      setLoaderVisible(true);
      setTeamToolsOpen(false);
      const updateTeamToolsVisibility = () => {
        if (!teamToolsContainer) return;
        const shouldShow = hasTeam && isCreator;
        teamToolsContainer.style.display = shouldShow ? '' : 'none';
        if (!shouldShow) {
          setTeamToolsOpen(false);
          if (teamToolsBadge) teamToolsBadge.style.display = 'none';
        }
      };
      const performResume = (name) => {
        if (!name) return;
        if (resumeInFlight) return;
        resumeInFlight = true;
        resetInitialDataState();
        socket.emit("resume", name);
        socket.emit('player_get_questions');
        socket.emit('player_get_info');
        socket.emit('player_get_hints_state');
      };
      // (removed) frozen notice banner per request
      leaveBtn.onclick = () => socket.emit("leave_team");

      document.getElementById("joinBtn").onclick = () => {
        const name = document.getElementById("name").value.trim();
        const extId = document.getElementById("extId").value.trim();
        if (!name || !extId) {
          showAlert("–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –∏–º–µ –∏ ID.", "warning");
          return;
        }
        if (!/^\d{6}$/.test(extId)) {
          showAlert("ID —Ç—Ä—è–±–≤–∞ –¥–∞ –µ —Ç–æ—á–Ω–æ 6 —Ü–∏—Ñ—Ä–∏.", "warning");
          return;
        }
        try { localStorage.setItem("externalId", extId); } catch {}
        socket.emit("join_player", { name, external_id: extId });
      };

      document.getElementById("createTeamBtn").onclick = () => {
        const teamName = document.getElementById("teamName").value.trim();
        if (!teamName) { showAlert("–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –∏–º–µ –Ω–∞ –æ—Ç–±–æ—Ä", "warning"); return; }
        // Client-side check for existing team name for instant feedback
        try {
          if ((lastTeams || []).some(t => (t.name || '').toLowerCase() === teamName.toLowerCase())) {
            showAlert("–ò–º–µ—Ç–æ –Ω–∞ –æ—Ç–±–æ—Ä–∞ –µ –∑–∞–µ—Ç–æ!", "error");
            return;
          }
        } catch {}
        socket.emit("create_team", teamName);
      };

      document.getElementById("teamsList").onclick = () => {
        
      }
      socket.on("joined_as_player", (name) => {
        document.getElementById("setup").style.display = "none";
        document.getElementById("teamSection").style.display = "block";
        playerNameSpan.textContent = name;
        try { localStorage.setItem("playerName", name); } catch {}
        resumeInFlight = false;
        resetInitialDataState();
        socket.emit('player_get_info');
        socket.emit('player_get_questions');
        socket.emit('player_get_hints_state');
      });

      socket.on("name_taken", () => showAlert("–ò–º–µ—Ç–æ –µ –∑–∞–µ—Ç–æ!", "error"));
      socket.on("invalid_external_id", () => {
        showAlert("ID —Ç—Ä—è–±–≤–∞ –¥–∞ –µ —Ç–æ—á–Ω–æ 6 —Ü–∏—Ñ—Ä–∏.", "warning");
        try { localStorage.removeItem("externalId"); } catch {}
      });
      socket.on("resume_failed", () => {
        resumeInFlight = false;
        try { localStorage.removeItem("playerName"); } catch {}
        setLoaderVisible(false);
      });
      socket.on("name_taken", () => showAlert("–ò–º–µ—Ç–æ –Ω–∞ –æ—Ç–±–æ—Ä–∞ –µ –∑–∞–µ—Ç–æ!", "error"));
      socket.on("team_full", () => showAlert("–û—Ç–±–æ—Ä—ä—Ç –µ –ø—ä–ª–µ–Ω!", "warning"));

      let lastTeams = [];
      let lastQuestions = [];
      let lastGame = null;
      let lastHints = { used: 0, left: 0, max: 0, hintedQuestionIds: [] };

      function renderQuestion() {
        if (!lastGame || !lastGame.started) {
          gameSection.style.display = 'none';
          finishedNotice.style.display = 'none';
          return;
        }
        const playerName = playerNameSpan.textContent;
        const currentTeam = lastTeams.find(t => t.players.includes(playerName));
        if (!currentTeam) { gameSection.style.display = 'none'; finishedNotice.style.display = 'none'; return; }
        const pos = currentTeam.current_question;
        const q = lastQuestions.find(qq => qq.position === pos);
        if (!q) {
          gameSection.style.display = 'none';
          finishedNotice.style.display = 'block';
          finishedNotice.innerHTML = `
            <div style="text-align:center;">
              <img src="https://cdn.az-moga.bg/up/2017/zebra.png" alt="congrats" style="max-width:300px; margin-bottom:20px;"/>
              <h2 style="color:#28a745;">–ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è! –°–ø—Ä–∞–≤–∏—Ö—Ç–µ —Å–µ –æ—Ç–ª–∏—á–Ω–æ —Å—ä—Å –∑–∞–≥–∞–¥–∫–∏—Ç–µ! üéâ</h2>
              <p style="font-size:18px; color:#333;">–¢–∏ –∏ —Ç–≤–æ—è—Ç –æ—Ç–±–æ—Ä –ø–æ–∫–∞–∑–∞—Ö—Ç–µ –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–∞ –ª–æ–≥–∏–∫–∞, –±—ä—Ä–∑–∏–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞ –≤ –µ–∫–∏–ø.</p>
            </div>
          `;
          return;
        }
        // While a question is active, ensure team UI is hidden and focus the question view
        if (welcomeHeader) welcomeHeader.style.display = 'none';
        createTeamControls.style.display = 'none';
        existingTeams.style.display = 'none';
        currentTeamSection.style.display = 'none';
        leaveBtn.style.display = 'none';

        const colors = ['#0e1a2a', '#ff8900', '#0657a4', '#000', '#349a47', '#d71724', '#ff8900', '#0657a4','#349a47', '#000'];
        const color = colors[(pos - 1) % colors.length];
        submitAnswerBtn.style.backgroundColor = color;
        gameSectionHeading.style.color = color;
        gameSectionHeading.textContent = `–ó–∞–≥–∞–¥–∫–∞ ${pos}`;
        // Handle image + loader
        if (q.image_url) {
          if (qImageLoader) qImageLoader.style.display = 'block';
          qImageEl.style.display = 'none';
          // Clear previous handlers, then attach
          qImageEl.onload = () => {
            if (qImageLoader) qImageLoader.style.display = 'none';
            qImageEl.style.display = 'block';
          };
          qImageEl.onerror = () => {
            if (qImageLoader) qImageLoader.style.display = 'none';
            qImageEl.style.display = 'none';
          };
          qImageEl.src = q.image_url;
        } else {
          if (qImageLoader) qImageLoader.style.display = 'none';
          qImageEl.style.display = 'none';
          qImageEl.removeAttribute('src');
        }
        qTextEl.textContent = q.text || '';
        console.log("Here, yes!");
        gameSection.style.display = 'flex';
        finishedNotice.style.display = 'none';
        // show hint if already taken for this question
        if (lastHints.hintedQuestionIds && lastHints.hintedQuestionIds.includes(q.id)) {
          qHintEl.style.display = 'block';
          qHintEl.textContent = `–ü–æ–¥—Å–∫–∞–∑–∫–∞: ${q.hint || ''}`;
        } else {
          qHintEl.style.display = 'none';
          qHintEl.textContent = '';
        }
        {
          const hintsLeftCount = (lastHints && typeof lastHints.left === 'number') ? lastHints.left : 0;
          const alreadyHinted = Array.isArray(lastHints?.hintedQuestionIds) && lastHints.hintedQuestionIds.includes(q.id);
          if (getHintBtn) getHintBtn.disabled = alreadyHinted ? true : (!isCreator || hintsLeftCount <= 0);
        }
        // Do not request hints state here to avoid feedback loops
      }
      socket.on("teams_update", (teams) => {
        const list = document.getElementById("teamsList");
        list.innerHTML = "";

        const playerName = playerNameSpan.textContent;
        const currentTeam = teams.find(t => t.players.includes(playerName));
        lastTeams = teams;
        markTeamsReady();
        hasTeam = !!currentTeam;
        updateTeamToolsVisibility();
        if (!hasTeam && teamToolsRequests) {
          teamToolsRequests.innerHTML = '';
          if (teamToolsBadge) teamToolsBadge.style.display = 'none';
        }
        leaveBtn.style.display = currentTeam ? "inline-block" : "none";
        // Refresh captain status on any team change
        socket.emit('player_get_info');

        const gameRunning = !!(lastGame && lastGame.started && !lastGame.ended);
        const teamHasProgress = currentTeam && Number(currentTeam.current_question) > 0;
        const awaitingState = !lastGame && teamHasProgress;
        const shouldFocusQuestion = !!(currentTeam && (gameRunning || awaitingState));

        // If the game is in progress (or we have not yet received state but the team is mid-quiz),
        // keep team UI hidden and focus on the question view
        if (shouldFocusQuestion) {
          if (welcomeHeader) welcomeHeader.style.display = 'none';
          createTeamControls.style.display = 'none';
          existingTeams.style.display = 'none';
          currentTeamSection.style.display = 'none';
          leaveBtn.style.display = 'none';
          // If this client is the captain, fetch pending join requests so the queue shows in-game
          if (currentTeam && playerName === currentTeam.captain) {
            socket.emit('captain_list_requests');
          }
          renderQuestion();
          // Refresh hints state so the button reflects latest remaining hints
          socket.emit('player_get_hints_state');
          return;
        }

        if (currentTeam) {
          createTeamControls.style.display = "none";
          existingTeams.style.display = "none";
          currentTeamSection.style.display = "block";
          currentTeamNameSpan.textContent = currentTeam.name;
          memberList.innerHTML = "";
          currentTeam.players.forEach((p) => {
            const li = document.createElement("li");
            li.textContent = p + (currentTeam.captain && currentTeam.captain === p ? " (–∫–∞–ø–∏—Ç–∞–Ω)" : "");
            memberList.appendChild(li);
          });
          // If this client is the captain (pre-game), fetch pending join requests to show under team section
          if (playerName === currentTeam.captain) {
            socket.emit('captain_list_requests');
          }
          renderQuestion();
          return;
        } else {
          createTeamControls.style.display = "block";
          existingTeams.style.display = "block";
          currentTeamSection.style.display = "none";
        }

        teams.forEach((team) => {
          const li = document.createElement("li");
          const isCurrent = currentTeam && currentTeam.name === team.name;

          const label = document.createElement("span");
          label.textContent = `${team.name} (${team.players.length}/5)` + (isCurrent ? " ‚Äî —Ç–≤–æ—è—Ç –æ—Ç–±–æ—Ä" : "");
          li.appendChild(label);

          if (isCurrent) {
            const leaveBtn = document.createElement("button");
            leaveBtn.className = 'btn';
            leaveBtn.textContent = "–ù–∞–ø—É—Å–Ω–∏";
            leaveBtn.onclick = () => socket.emit("leave_team");
            li.appendChild(leaveBtn);
          } else if (!currentTeam) {
            const joinBtn = document.createElement("button");
            joinBtn.className = 'btn btn--primary-reversed';
            joinBtn.textContent = "–í–ª–µ–∑";
            joinBtn.onclick = () => {
              pendingJoinFor = team.name;
              socket.emit("request_join_team", team.name);
            };
            li.appendChild(joinBtn);
          }

          list.appendChild(li);
        });
      });

      socket.on("must_leave_first", () => showAlert("–ü—ä—Ä–≤–æ –Ω–∞–ø—É—Å–Ω–∏ —Ç–µ–∫—É—â–∏—è —Å–∏ –æ—Ç–±–æ—Ä, –ø—Ä–µ–¥–∏ –¥–∞ —Å–µ –ø—Ä–∏—Å—ä–µ–¥–∏–Ω–∏—à –∫—ä–º –¥—Ä—É–≥.", "warning"));

      function setFrozenUI(isFrozen) {
        if (isFrozen) {
          createTeamControls.style.display = 'none';
          existingTeams.style.display = 'none';
          leaveBtn.style.display = 'none';
        }
      }
      socket.on("questions_payload", (payload) => {
        lastQuestions = payload.questions || [];
        lastGame = payload.game || null;
        markQuestionsReady();
        const activeGame = lastGame && lastGame.started && !lastGame.ended;
        const hasTeam = lastTeams.some(t => t.players.includes(playerNameSpan.textContent));
        // Only hide team UI if the game is actually running for players inside a team
        if (activeGame && hasTeam) {
          if (welcomeHeader) welcomeHeader.style.display = 'none';
          createTeamControls.style.display = 'none';
          existingTeams.style.display = 'none';
          currentTeamSection.style.display = 'none';
          leaveBtn.style.display = 'none';
        }
        renderQuestion();
        // ensure hints counter/button are accurate right after receiving questions
        socket.emit('player_get_hints_state');
      });

      // Targeted questions payload after captain approves
      socket.on("questions_payload_for", (payload) => {
        if (!payload || payload.playerName !== playerNameSpan.textContent) return;
        lastQuestions = payload.questions || [];
        lastGame = payload.game || null;
        markQuestionsReady();
        const activeGameTargeted = lastGame && lastGame.started && !lastGame.ended;
        const hasTeamTargeted = lastTeams.some(t => t.players.includes(playerNameSpan.textContent));
        // Only hide team UI if the game is actually running for players inside a team
        if (activeGameTargeted && hasTeamTargeted) {
          if (welcomeHeader) welcomeHeader.style.display = 'none';
          createTeamControls.style.display = 'none';
          existingTeams.style.display = 'none';
          currentTeamSection.style.display = 'none';
          leaveBtn.style.display = 'none';
        }
        renderQuestion();
        // ensure hints counter/button are accurate for this player right away
        socket.emit('player_get_hints_state');
      });

      submitAnswerBtn.onclick = () => {
        const val = answerInput.value.trim();
        if (!val) return;
        socket.emit('submit_answer', val);
      };

      socket.on('answer_result', (res) => {
        if (!res || !res.correct) {
          answerInput.style.borderColor = 'red';
          answerInput.style.borderWidth = '2px';
          return;
        }
        else {
          answerInput.style.borderColor = 'grey';
          answerInput.style.borderWidth = '2px';
          answerInput.value = '';
        }
        // correct: optionally clear input; next question renders from teams_update
        
      });

      // Hints: request and update
      getHintBtn.onclick = () => {
        socket.emit('request_hint');
        getHintBtn.disabled = true;
      };

      socket.on('hints_state', (stateHints) => {
        lastHints = stateHints || { used: 0, left: 0, max: 0, hintedQuestionIds: [] };
        const left = (lastHints && typeof lastHints.left === 'number') ? lastHints.left : 0;
        hintsLeftEl.textContent = String(left);
        // hide hint button for non-captains; show for captains with hints left
        hintControls.style.display = isCreator ? '' : 'none';
        getHintBtn.disabled = left <= 0 || !isCreator;
        // Update hint visibility for the current question without re-rendering everything
        const playerName = playerNameSpan.textContent;
        const currentTeam = lastTeams.find(t => t.players.includes(playerName));
        if (currentTeam && lastGame && lastGame.started) {
          const pos = currentTeam.current_question;
          const q = lastQuestions.find(qq => qq.position === pos);
          if (q) {
            if (lastHints.hintedQuestionIds && lastHints.hintedQuestionIds.includes(q.id)) {
              qHintEl.style.display = 'block';
              qHintEl.textContent = `–ñ–æ–∫–µ—Ä: ${q.hint || ''}`;
              getHintBtn.disabled = true;
            } else {
              qHintEl.style.display = 'none';
              qHintEl.textContent = '';
              getHintBtn.disabled = left <= 0 || !isCreator;
            }
          }
        }
      });

      socket.on('hint_revealed', (payload) => {
        // Only care if it's our team
        const playerName = playerNameSpan.textContent;
        const currentTeam = lastTeams.find(t => t.players.includes(playerName));
        if (!currentTeam || !payload || payload.teamId !== currentTeam.id) return;
        // Update counters and show hint if it's for the current question
        hintsLeftEl.textContent = String(payload.left ?? hintsLeftEl.textContent);
        const posTeam = currentTeam.current_question;
        const q = lastQuestions.find(qq => qq.position === posTeam);
        if (q && payload.questionId === q.id) {
          qHintEl.style.display = 'block';
          qHintEl.textContent = `–ñ–æ–∫–µ—Ä: ${payload.hint || ''}`;
          getHintBtn.disabled = true;
        }
      });

      // Show answer controls only for team captains
      socket.on('player_info', (info) => {
        isCreator = !!(info && info.is_creator);
        const controls = answerInput.parentElement;
        if (controls) controls.style.display = isCreator ? '' : 'none';
        hintControls.style.display = isCreator ? '' : 'none';
        updateTeamToolsVisibility();
        // Captains fetch join request queue
        if (isCreator) {
          socket.emit('captain_list_requests');
        }
      });

      socket.on("game_started", () => {
        showAlert("–ò–≥—Ä–∞—Ç–∞ –∑–∞–ø–æ—á–Ω–∞!", "success");
        const playerName = playerNameSpan.textContent;
        const currentTeam = lastTeams.find(t => t.players.includes(playerName));
        if (currentTeam) {
          if (welcomeHeader) welcomeHeader.style.display = 'none';
          leaveBtn.style.display = 'none';
          createTeamControls.style.display = 'none';
          existingTeams.style.display = 'none';
          currentTeamSection.style.display = 'none';
        } else {
          if (welcomeHeader) welcomeHeader.style.display = '';
          leaveBtn.style.display = 'none';
          createTeamControls.style.display = 'block';
          existingTeams.style.display = 'block';
          currentTeamSection.style.display = 'none';
        }
        socket.emit('player_get_questions');
        socket.emit('player_get_hints_state');
        if (isCreator) socket.emit('captain_list_requests');
      });
      socket.on("game_ended", () => {
        showAlert("–ò–≥—Ä–∞—Ç–∞ –ø—Ä–∏–∫–ª—é—á–∏!", "info");
        const playerName = playerNameSpan.textContent;
        const currentTeam = lastTeams.find(t => t.players.includes(playerName));
        lastGame = { started: 0, ended: 1 };
        finishedNotice.style.display = 'none';
        gameSection.style.display = 'none';
        if (currentTeam) {
          if (welcomeHeader) welcomeHeader.style.display = '';
          createTeamControls.style.display = 'none';
          existingTeams.style.display = 'none';
          currentTeamSection.style.display = 'block';
          currentTeamNameSpan.textContent = currentTeam.name;
          memberList.innerHTML = '';
          currentTeam.players.forEach((p) => {
            const li = document.createElement('li');
            li.textContent = p + (currentTeam.captain && currentTeam.captain === p ? " (–∫–∞–ø–∏—Ç–∞–Ω)" : "");
            memberList.appendChild(li);
          });
          leaveBtn.style.display = 'inline-block';
          if (playerName === currentTeam.captain) {
            socket.emit('captain_list_requests');
          }
        } else {
          if (welcomeHeader) welcomeHeader.style.display = '';
          createTeamControls.style.display = 'block';
          existingTeams.style.display = 'block';
          currentTeamSection.style.display = 'none';
          leaveBtn.style.display = 'none';
        }
        renderQuestion();
      });
      socket.on("game_frozen", () => showAlert("–û—Ç–±–æ—Ä–∏—Ç–µ —Å–∞ –∑–∞–∫–ª—é—á–µ–Ω–∏. –ò–∑—á–∞–∫–∞–π—Ç–µ –∫—Ä–∞—è –Ω–∞ –∏–≥—Ä–∞—Ç–∞.", "info"));

      const populateSavedExternalId = () => {
        try {
          const savedId = localStorage.getItem("externalId");
          if (savedId) {
            const idEl = document.getElementById("extId");
            if (idEl) idEl.value = savedId;
          }
        } catch {}
      };

      const attemptStoredResume = () => {
        populateSavedExternalId();
        try {
          const saved = localStorage.getItem("playerName");
          if (saved) {
            performResume(saved);
          } else {
            setLoaderVisible(false);
          }
        } catch {
          setLoaderVisible(false);
        }
      };

      socket.on('connect', () => {
        attemptStoredResume();
      });

      socket.on('disconnect', () => {
        resumeInFlight = false;
        resetInitialDataState();
      });

      populateSavedExternalId();
      if (socket.connected) {
        attemptStoredResume();
      }

      // ---- Join request client handlers ----

      socket.on('join_request_ack', ({ teamName }) => {
        if (teamName && pendingJoinFor === teamName) {
          joinPending.style.display = '';
          joinPending.textContent = `–ó–∞—è–≤–∫–∞—Ç–∞ –∫—ä–º ${teamName} –æ—á–∞–∫–≤–∞ –æ–¥–æ–±—Ä–µ–Ω–∏–µ‚Ä¶`;
          // joinBtn.disabled = "disabled";
        }
      });

      socket.on('join_result', ({ playerName, accepted, reason }) => {
        if (playerName !== playerNameSpan.textContent) return;
        joinPending.style.display = 'none';
        pendingJoinFor = null;
        if (!accepted) {
          if (reason === 'team_full') showAlert('–û—Ç–±–æ—Ä—ä—Ç –µ –ø—ä–ª–µ–Ω', 'warning');
          else if (reason === 'rejected') showAlert('–ó–∞—è–≤–∫–∞—Ç–∞ –µ –æ—Ç—Ö–≤—ä—Ä–ª–µ–Ω–∞', 'info');
          else if (reason === 'stale') showAlert('–ó–∞—è–≤–∫–∞—Ç–∞ –≤–µ—á–µ –Ω–µ –µ –≤–∞–ª–∏–¥–Ω–∞', 'info');
          // else if (reason === 'already_in_team') showAlert('You are already in a team', 'info');
        }
      });

      // Captains: render and refresh queue
      function renderRequests(items) {
        if (!teamToolsRequests) return;
        const list = Array.isArray(items) ? items : [];
        teamToolsRequests.innerHTML = '';
        if (!list.length) {
          const empty = document.createElement('p');
          empty.className = 'muted';
          empty.textContent = '–ù—è–º–∞ —á–∞–∫–∞—â–∏ –∑–∞—è–≤–∫–∏.';
          teamToolsRequests.appendChild(empty);
        } else {
          const heading = document.createElement('h4');
          heading.textContent = '–ß–∞–∫–∞—â–∏ –∑–∞—è–≤–∫–∏';
          heading.style.marginTop = '0';
          teamToolsRequests.appendChild(heading);
          const ul = document.createElement('ul');
          ul.className = 'team-tools__requests-list';
          list.forEach(({ player_name }) => {
            const li = document.createElement('li');
            const label = document.createElement('span');
            label.textContent = player_name;
            li.appendChild(label);
            const actions = document.createElement('span');
            const acceptBtn = document.createElement('button');
            acceptBtn.className = 'btn btn--primary';
            acceptBtn.textContent = '–û–¥–æ–±—Ä–∏';
            acceptBtn.onclick = () => socket.emit('captain_decide_join', { playerName: player_name, accept: true });
            const rejectBtn = document.createElement('button');
            rejectBtn.className = 'btn btn--danger';
            rejectBtn.textContent = '–û—Ç–∫–∞–∂–∏';
            rejectBtn.onclick = () => socket.emit('captain_decide_join', { playerName: player_name, accept: false });
            actions.appendChild(acceptBtn);
            actions.appendChild(rejectBtn);
            actions.style.display = 'flex';
            actions.style.gap = '8px';
            li.appendChild(actions);
            ul.appendChild(li);
          });
          teamToolsRequests.appendChild(ul);
        }
        if (teamToolsBadge) {
          if (list.length) {
            teamToolsBadge.style.display = 'inline-flex';
            teamToolsBadge.textContent = String(list.length);
          } else {
            teamToolsBadge.style.display = 'none';
          }
        }
      }

      socket.on('join_requests', ({ items }) => {
        if (isCreator) {
          renderRequests(items);
        }
      });

      socket.on('join_request', ({ teamId }) => {
        if (isCreator) socket.emit('captain_list_requests');
      });
    </script>
  </body>
</html>





