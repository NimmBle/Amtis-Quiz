<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/styles.css" />
    <title>Admin Dashboard</title>
  </head>
  <body>
    <h2>Admin Dashboard</h2>
    <div id="login" class="row">
      <input id="adminCode" class="input" type="password" placeholder="Enter admin code" />
      <button id="adminLoginBtn" class="btn btn--primary">Login</button>
      <span id="adminMsg" class="muted"></span>
    </div>
    <div id="dashboard" style="display:none;">
      <div id="controls" class="row mb-3">
        <button id="startBtn" class="btn btn--primary">Start Game</button>
        <button id="endBtn" class="btn btn--danger">End Game</button>
        <span id="gameStateSpan" class="muted"></span>
      </div>
      <div id="overview" class="mb-4">
        <h3>Overview</h3>
        <div class="overflow-auto">
          <table id="teamsTable" class="min-600">
            <thead id="teamsTableHead"></thead>
            <tbody id="teamsTableBody"></tbody>
          </table>
        </div>
      </div>
      <div class="row-start">
        <div id="questionsPanel" class="flex-2">
          <h3>Questions</h3>
          <div class="row mb-3"><label>Max hints per team: <input id='maxHintsInput' class='input w-80' type='number' min='0' step='1' /></label> <button id='saveMaxHintsBtn' class='btn'>Save</button> <span id='maxHintsMsg' class='muted'></span></div>
          <ol id="questionsList"></ol>
          <div class="row mt-2">
            <input id="qImage" class="input w-30" placeholder="Image URL" />
            <input id="qText" class="input w-22" placeholder="Question text" />
            <input id="qHint" class="input w-22" placeholder="Hint (required)" />
            <input id="qAnswer" class="input w-22" placeholder="Correct Answer (required)" />
            <button id="addQBtn" class="btn btn--primary">Add</button>
          </div>
        </div>
      </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const loginDiv = document.getElementById('login');
      const dashboardDiv = document.getElementById('dashboard');
      const adminMsg = document.getElementById('adminMsg');
      const adminCodeInput = document.getElementById('adminCode');
      const adminLoginBtn = document.getElementById('adminLoginBtn');
      const startBtn = document.getElementById('startBtn');
      const endBtn = document.getElementById('endBtn');
      const gameStateSpan = document.getElementById('gameStateSpan');
      const teamsTable = document.getElementById('teamsTable');
      const teamsTableHead = document.getElementById('teamsTableHead');
      const teamsTableBody = document.getElementById('teamsTableBody');
      const qImage = document.getElementById('qImage');
      const qText = document.getElementById('qText');
      const qHint = document.getElementById('qHint');
      const qAnswer = document.getElementById('qAnswer');
      const maxHintsInput = document.getElementById('maxHintsInput');
      const saveMaxHintsBtn = document.getElementById('saveMaxHintsBtn');
      const maxHintsMsg = document.getElementById('maxHintsMsg');
      const addQBtn = document.getElementById('addQBtn');
      const questionsList = document.getElementById('questionsList');
      let state = { teams: [], questions: [], answers: [], game: null, max_hints: 3, used_hints: [] };
      function renderGame() {
        const g = state.game || { started: 0, ended: 0 };
        gameStateSpan.textContent = `Started: ${g.started ? 'yes' : 'no'} | Ended: ${g.ended ? 'yes' : 'no'}`;
      }
      function renderTeams() {
        teamsTableHead.innerHTML = '';
        const headRow = document.createElement('tr');
        const thTeam = document.createElement('th');
        thTeam.textContent = 'Team';
        headRow.appendChild(thTeam);

        const thPlayers = document.createElement('th');
        thPlayers.textContent = 'Players';
        headRow.appendChild(thPlayers);

        state.questions.forEach((q, idx) => {
          const th = document.createElement('th');
          th.textContent = `Q${idx + 1}`;
          headRow.appendChild(th);
        });
        const thActions = document.createElement('th');
        thActions.textContent = 'Actions';
        headRow.appendChild(thActions);
        teamsTableHead.appendChild(headRow);

        const thHintsUsed = document.createElement('th');
        thHintsUsed.textContent = 'Hints Used';
        headRow.appendChild(thHintsUsed);

        const answersMap = new Map();
        state.answers.forEach((a) => {
          let m = answersMap.get(a.team_id);
          if (!m) { m = new Map(); answersMap.set(a.team_id, m); }
          m.set(a.question_id, a.answer);
        });
        const hintsByTeam = new Map();
        (state.used_hints || []).forEach((h) => {
          const current = hintsByTeam.get(h.team_id) || 0;
          hintsByTeam.set(h.team_id, current + 1);
        });

        teamsTableBody.innerHTML = '';
        state.teams.forEach((t) => {
          const tr = document.createElement('tr');
          const tdTeam = document.createElement('td');
          tdTeam.textContent = t.name;
          tr.appendChild(tdTeam);

          const tdPlayers = document.createElement('td');
          tdPlayers.style.whiteSpace = 'pre-line';
          if (t.players_detail && t.players_detail.length) {
            const lines = t.players_detail.map((p) => p.name + (p.external_id ? ' (' + p.external_id + ')' : ''));
            tdPlayers.textContent = lines.join('\n');
          } else {
            tdPlayers.textContent = (t.players || []).join(', ');
          }
          tr.appendChild(tdPlayers);

          state.questions.forEach((q) => {
            const td = document.createElement('td');
            const ans = (answersMap.get(t.id) || new Map()).get(q.id);
            td.textContent = (ans != null && ans !== '') ? ans : (t.current_question === q.position ? '->' : '');
            tr.appendChild(td);
          });

          const tdActions = document.createElement('td');
          const delBtn = document.createElement('button');
          delBtn.className = 'btn btn--danger';
          delBtn.textContent = 'Delete';
          delBtn.onclick = () => { if (confirm(`Delete team ${t.name}?`)) socket.emit('admin_delete_team', t.id); };
          tdActions.appendChild(delBtn);
          tr.appendChild(tdActions);

          const tdHintsUsed = document.createElement('td');
          tdHintsUsed.textContent = String(hintsByTeam.get(t.id) || 0);
          tr.appendChild(tdHintsUsed);

          teamsTableBody.appendChild(tr);
        });
      }function renderQuestions() {
        questionsList.innerHTML = '';
        state.questions.forEach((q, idx) => {
          const li = document.createElement('li');
          const line = document.createElement('div');
          line.className = 'row';
          // Inline editable inputs for question fields
          const imgInput = document.createElement('input');
          imgInput.className = 'input';
          imgInput.placeholder = 'Image URL';
          imgInput.classList.add('w-30');
          imgInput.value = q.image_url || '';
          imgInput.disabled = true;
          const textInput = document.createElement('input');
          textInput.className = 'input';
          textInput.placeholder = 'Question text';
          textInput.classList.add('w-22');
          textInput.value = q.text || '';
          textInput.disabled = true;
          const hintInput = document.createElement('input');
          hintInput.className = 'input';
          hintInput.placeholder = 'Hint (required)';
          hintInput.classList.add('w-22');
          hintInput.value = q.hint || '';
          hintInput.disabled = true;
          const ansInput = document.createElement('input');
          ansInput.className = 'input';
          ansInput.placeholder = 'Correct Answer (required)';
          ansInput.classList.add('w-22');
          ansInput.value = q.correct_answer || '';
          ansInput.disabled = true;
          const ansSpan = document.createElement('div');
          ansSpan.textContent = q.correct_answer ? `Answer: ${q.correct_answer}` : 'Answer: (missing)';
          ansSpan.style.color = q.correct_answer ? '#555' : '#b00';
          const upBtn = document.createElement('button');
          upBtn.className = 'btn';
          upBtn.textContent = 'Up';
          upBtn.style.marginLeft = '8px';
          upBtn.disabled = idx === 0;
          upBtn.onclick = () => socket.emit('admin_move_question', { id: q.id, direction: 'up' });
          const downBtn = document.createElement('button');
          downBtn.className = 'btn';
          downBtn.textContent = 'Down';
          downBtn.style.marginLeft = '4px';
          downBtn.disabled = idx === state.questions.length - 1;
          downBtn.onclick = () => socket.emit('admin_move_question', { id: q.id, direction: 'down' });
          const editSaveBtn = document.createElement('button');
          editSaveBtn.className = 'btn btn--primary';
          editSaveBtn.textContent = 'Edit';
          editSaveBtn.style.marginLeft = '8px';
          let editing = false;
          const setEditing = (on) => {
            editing = on;
            imgInput.disabled = !on;
            textInput.disabled = !on;
            hintInput.disabled = !on;
            ansInput.disabled = !on;
            editSaveBtn.textContent = on ? 'Save' : 'Edit';
          };
          editSaveBtn.onclick = () => {
            if (!editing) {
              setEditing(true);
              return;
            }
            const image_url = imgInput.value.trim();
            const text = textInput.value.trim();
            const hint = hintInput.value.trim();
            const correct_answer = ansInput.value.trim();
            if (!hint || !correct_answer) { alert('Hint and Correct Answer are required'); return; }
            socket.emit('admin_update_question', { id: q.id, image_url, text, hint, correct_answer });
            setEditing(false);
          };
          const removeBtn = document.createElement('button');
          removeBtn.className = 'btn btn--danger';
          removeBtn.textContent = 'Remove';
          removeBtn.style.marginLeft = '8px';
          removeBtn.onclick = () => socket.emit('admin_remove_question', q.id);
          line.appendChild(imgInput);
          line.appendChild(textInput);
          line.appendChild(hintInput);
          line.appendChild(ansInput);
          line.appendChild(upBtn);
          line.appendChild(downBtn);
          line.appendChild(editSaveBtn);
          line.appendChild(removeBtn);
          li.appendChild(line);
          // no extra spans; values are inline above
          if (q.image_url) {
            const preview = document.createElement('img');
            preview.src = q.image_url;
            preview.alt = 'preview';
            preview.style.maxWidth = '160px';
            preview.style.display = 'block';
            preview.style.margin = '6px 0';
            li.appendChild(preview);
          }
          questionsList.appendChild(li);
        });
      }
      function renderAll() {
        renderGame();
        renderTeams();
        renderQuestions();
      }
      adminLoginBtn.onclick = () => {
        const code = adminCodeInput.value.trim();
        if (!code) { adminMsg.textContent = 'Enter code'; return; }
        adminMsg.textContent = '';
        try { localStorage.setItem('adminCode', code); } catch {}
        socket.emit('admin_login', code);
      };
      startBtn.onclick = () => socket.emit('start_game');
      endBtn.onclick = () => socket.emit('end_game');
      addQBtn.onclick = () => {
        const image_url = qImage.value.trim();
        const text = qText.value.trim();
        const hint = qHint.value.trim();
        const correct_answer = qAnswer.value.trim();
        if (!hint) { alert('Hint is required'); return; }
        if (!correct_answer) { alert('Correct answer is required'); return; }
        socket.emit('admin_add_question', { image_url, text, hint, correct_answer });
        qImage.value = '';
        qText.value = '';
        qHint.value = '';
        qAnswer.value = '';
      };
      socket.on('admin_logged_in', () => {
        loginDiv.style.display = 'none';
        dashboardDiv.style.display = 'block';
      });
      socket.on('admin_state', (payload) => {
        state = payload;
        if (typeof state.max_hints === 'number' && !Number.isNaN(state.max_hints)) {
          maxHintsInput.value = String(state.max_hints);
          maxHintsMsg.textContent = '';
        }
        renderAll();
      });
      socket.on('teams_update', (teams) => {
        state.teams = teams;
        renderTeams();
      });
            saveMaxHintsBtn.onclick = () => {
        const n = parseInt(maxHintsInput.value, 10);
        if (!Number.isFinite(n) || n < 0) { maxHintsMsg.textContent = 'Enter a non-negative number'; return; }
        maxHintsMsg.textContent = 'Saving...';
        socket.emit('admin_set_max_hints', n);
        setTimeout(() => { maxHintsMsg.textContent = 'Saved'; }, 300);
      };socket.on('questions_update', (questions) => {
        state.questions = questions;
        renderQuestions();
      });
      socket.on('admin_error', (msg) => {
        adminMsg.textContent = msg || 'Error';
      });
      socket.on('game_started', () => {
        if (state.game) state.game.started = 1, state.game.ended = 0;
        renderGame();
      });
      socket.on('game_ended', () => {
        if (state.game) state.game.ended = 1;
        renderGame();
      });
      // Attempt auto-login using stored code
      try {
        const saved = localStorage.getItem('adminCode');
        if (saved) {
          socket.emit('admin_login', saved);
        }
      } catch {}
    </script>
  </body>
  </html>





